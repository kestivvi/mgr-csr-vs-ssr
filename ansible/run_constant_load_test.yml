---
- name: Run k6 Constant Load Test Synchronously
  hosts: all # <-- UPDATED: Changed to 'all' to be a generic toolkit
  gather_facts: no
  vars:
    # These values can be overridden from the ansible-playbook command if needed
    k6_rps: 100
    k6_duration: "5m"
    prometheus_url: "http://{{ hostvars[groups['role_monitoring_server'][0]]['private_ip'] }}:9090"

  tasks:
    - name: Define server-specific variables
      ansible.builtin.set_fact:
        # Create the uppercase version of the scenario type for use in templates
        scenario_type_upper: "{{ scenario_type | upper }}"
        # Dynamically construct the target URL using the private IP of the corresponding app server
        target_url: "http://{{ hostvars[groups['app_server_' + scenario_type][0]]['private_ip'] }}"

    - name: Display Target URL for verification
      ansible.builtin.debug:
        msg: "Host {{ inventory_hostname }} (type: {{ scenario_type_upper }}) will target {{ target_url }}"

    - name: Clean up any previous k6 archive artifacts
      ansible.builtin.file:
        path: /home/ec2-user/k6_archive.tar
        state: absent
      become: yes

    - name: Copy k6 test archive to remote host
      ansible.builtin.copy:
        src: "{{ project_root }}/k6/build/k6_archive.tar"
        dest: /home/ec2-user/k6_archive.tar
        mode: '0644'

    - name: Ensure k6 Docker image is present
      community.docker.docker_image:
        name: "grafana/k6:1.1.0"
        source: pull

    - name: Run k6 constant load test
      block:
        - name: Create k6 runner script from template
          ansible.builtin.template:
            src: templates/run_constant_k6.sh.j2
            dest: /tmp/run_constant_k6.sh
            mode: '0755'

        - name: Execute k6 runner script
          ansible.builtin.shell:
            cmd: /tmp/run_constant_k6.sh
          register: k6_result
          changed_when: true

      always:
        - name: Clean up k6 runner script
          ansible.builtin.file:
            path: /tmp/run_constant_k6.sh
            state: absent