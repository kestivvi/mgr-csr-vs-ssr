#!/bin/bash
set -euo pipefail

# This script runs the k6 constant load test inside a Docker container.
# It is generated by Ansible and all variables are templated.

docker run --rm --net=host -i \
  -v /home/ec2-user/k6_archive.tar:/k6_archive.tar:ro \
  -e K6_SCENARIO=constant_test \
  -e SERVER_TYPE={{ scenario_type_upper }} \
  -e TARGET_URL="{{ target_url }}" \
  -e K6_RPS={{ k6_rps }} \
  -e K6_DURATION={{ k6_duration }} \
  -e K6_PROMETHEUS_RW_SERVER_URL="{{ prometheus_url }}/api/v1/write" \
  -e K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM=true \
  -e K6_LOG_OUTPUT=none \
  grafana/k6:1.1.0 run \
    --out experimental-prometheus-rw \
    --tag server={{ scenario_type_upper }} \
    /k6_archive.tar